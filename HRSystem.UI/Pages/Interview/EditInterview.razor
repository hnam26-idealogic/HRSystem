@page "/interviews/edit/{Id:guid}"
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using HRSystem.UI.DTOs
@inject IInterviewService InterviewService
@inject ICandidateService CandidateService
@inject IUserService UserService
@inject IAuthService AuthService

@inject NavigationManager Navigation

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h3 class="mb-0">Edit Interview</h3>
                </div>
                <div class="card-body">
                    @if (editInterviewModel == null)
                    {
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status"></div>
                            <span class="ms-2">Loading...</span>
                        </div>
                    }
                    else
                    {
                        <EditForm Model="@editInterviewModel" OnValidSubmit="HandleEditInterview">
                            <div class="row">
                                @if (IsInterviewer)
                                {
                                    <div class="col-md-6 mb-3">
                                        <label>Upload New Recording</label>
                                        <InputFile class="form-control" OnChange="HandleEditRecordingChange" accept="audio/*,video/*" />
                                        @if (!string.IsNullOrEmpty(currentRecordingPath))
                                        {
                                            <div class="mt-2">
                                                <a class="btn btn-outline-primary btn-sm me-1" href="@currentRecordingPath" target="_blank">
                                                    <i class="bi bi-eye"></i>Current Recording
                                                </a>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(recordingErrorMessage))
                                        {
                                            <div class="text-danger mt-1">@recordingErrorMessage</div>
                                        }
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label>English Score</label>
                                        <InputNumber class="form-control" @bind-value="editInterviewModel.English" placeholder="English Score" />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label>Technical Score</label>
                                        <InputNumber class="form-control" @bind-value="editInterviewModel.Technical" placeholder="Technical Score" />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label>Recommend Score</label>
                                        <InputNumber class="form-control" @bind-value="editInterviewModel.Recommend" placeholder="Recommend Score" />
                                    </div>
                                }
                                else
                                {
                                    <div class="col-md-6 mb-3">
                                        <label>Candidate</label>
                                        <input class="form-control" value="@candidates.FirstOrDefault(c => c.Id == editInterviewModel.CandidateId)?.Fullname" readonly />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label>Interviewer</label>
                                        <InputSelect class="form-select" @bind-value="editInterviewModel.InterviewerEmail">
                                            <option value="">Select Interviewer</option>
                                            @foreach (var interviewer in interviewers)
                                            {
                                                <option value="@interviewer.Email">@interviewer.Fullname (@interviewer.Email)</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label>HR</label>
                                        <input type="text" class="form-control bg-light" value="@currentHrDisplay" readonly />
                                        <small class="text-muted">You will be assigned as the HR for this interview</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label>Job</label>
                                        <InputText class="form-control" @bind-value="editInterviewModel.Job" placeholder="Job" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label>Interview Date & Time</label>
                                        <input type="datetime-local" class="form-control" @bind="editInterviewModel.InterviewedAt" />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label>English Score</label>
                                        <InputNumber class="form-control" @bind-value="editInterviewModel.English" placeholder="English Score" />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label>Technical Score</label>
                                        <InputNumber class="form-control" @bind-value="editInterviewModel.Technical" placeholder="Technical Score" />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label>Recommend Score</label>
                                        <InputNumber class="form-control" @bind-value="editInterviewModel.Recommend" placeholder="Recommend Score" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label>Status</label>
                                        <InputSelect class="form-select" @bind-value="editInterviewModel.Status">
                                            <option value="Scheduled">Scheduled</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Cancelled">Cancelled</option>
                                            <option value="Pending">Pending</option>
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label>Upload New Recording</label>
                                        <InputFile class="form-control" OnChange="HandleEditRecordingChange" accept="audio/*,video/*" />
                                        @if (!string.IsNullOrEmpty(currentRecordingPath))
                                        {
                                            <div class="mt-2">
                                                <a class="btn btn-outline-primary btn-sm me-1" href="@currentRecordingPath" target="_blank">
                                                    <i class="bi bi-eye"></i>Current Recording
                                                </a>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(recordingErrorMessage))
                                        {
                                            <div class="text-danger mt-1">@recordingErrorMessage</div>
                                        }
                                    </div>
                                }
                            </div>
                            <button type="submit" class="btn btn-warning w-100">Save Interview</button>
                            <button type="button" class="btn btn-secondary w-100 mt-2" @onclick="NavigateBack">Cancel</button>
                        </EditForm>
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger mt-3">@errorMessage</div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public Guid Id { get; set; }
    private UpdateInterviewRequestDto editInterviewModel;
    private List<CandidateDto> candidates = new();
    private List<UserDto> interviewers = new();
    private List<UserDto> hrs = new();
    private IBrowserFile editRecordingFile;
    private string errorMessage;
    private string? authorizationError;
    private string currentRecordingPath;
    private string recordingErrorMessage;
    private bool IsInterviewer;
    private string currentHrDisplay = "Loading...";
    private bool isLoading = true;
    
    protected override async Task OnInitializedAsync()
    {
        
        var interview = await InterviewService.GetByIdAsync(Id);
        var candidate = await CandidateService.GetByIdAsync(interview.CandidateId);
        var allUsers = await UserService.GetAllAsync();
        interviewers = allUsers.Where(u => u.AppRoles != null && u.AppRoles.Contains("Interviewer")).ToList();
        hrs = allUsers.Where(u => u.AppRoles != null && u.AppRoles.Contains("HR")).ToList();

        candidates = candidate != null ? new List<CandidateDto> { candidate } : new List<CandidateDto>();

        editInterviewModel = new UpdateInterviewRequestDto
        {
            CandidateId = interview.CandidateId,
            InterviewerEmail = interview.InterviewerEmail,
            HrEmail = interview.HrEmail,
            Job = interview.Job,
            // Set current datetime if InterviewedAt is not set
            InterviewedAt = interview.InterviewedAt == default ? DateTime.Now : interview.InterviewedAt,
            English = interview.English,
            Technical = interview.Technical,
            Recommend = interview.Recommend,
            Status = interview.Status
        };
        currentRecordingPath = interview.Recording;

        // Get current user information from claims (FAST - no API call)
            var currentUserEmail = await AuthService.GetCurrentUserEmailAsync();
            var currentUserName = await AuthService.GetCurrentUserNameAsync();

            if (string.IsNullOrEmpty(currentUserEmail))
            {
                authorizationError = "Unable to retrieve your email from authentication token.";
                isLoading = false;
                return;
            }

            // Set HR email and display name
            editInterviewModel.HrEmail = currentUserEmail;
            currentHrDisplay = !string.IsNullOrEmpty(currentUserName)
                ? $"{currentUserName} ({currentUserEmail})"
                : currentUserEmail;

        IsInterviewer = await AuthService.IsInRoleAsync("HR");

    
    }

    private void HandleEditRecordingChange(InputFileChangeEventArgs e)
    {
        recordingErrorMessage = string.Empty;
        var file = e.File;
        if (file == null)
        {
            recordingErrorMessage = "Please select a recording file.";
            editRecordingFile = null;
            return;
        }
        editRecordingFile = file;
    }

    private async Task HandleEditInterview()
    {
        var success = await InterviewService.UpdateAsync(Id, editInterviewModel, editRecordingFile);
        if (success)
        {
            Navigation.NavigateTo("/interviews");
        }
        else
        {
            errorMessage = "Failed to update interview.";
        }
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/interviews");
    }
}