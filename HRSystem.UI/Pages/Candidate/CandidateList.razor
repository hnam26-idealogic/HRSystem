@page "/candidates"
@inject ICandidateService CandidateService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@attribute [Authorize(Roles = "HR, Interviewer")]

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Candidates</h2>
            <p class="text-muted mb-0">Manage and search for potential candidates</p>
        </div>
        <button class="btn btn-success shadow-sm" @onclick="NavigateToAdd">
            <i class="bi bi-person-plus-fill me-2"></i>Add Candidate
        </button>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search text-muted"></i>
                </span>
                <input type="text" class="form-control border-start-0 ps-0" 
                       placeholder="Search by name, email, or resume content..." 
                       @bind="searchQuery" 
                       @bind:event="oninput" 
                       @onkeyup="HandleKeyUp" />
                
                @if (!string.IsNullOrWhiteSpace(searchQuery))
                {
                    <button class="btn btn-outline-secondary border-start-0" type="button" @onclick="ClearSearch">
                        <i class="bi bi-x-lg"></i>
                    </button>
                }
                
                <button class="btn btn-primary" type="button" @onclick="SearchCandidates">
                    Search
                </button>
            </div>
            <div class="form-text text-muted mt-2">
                <i class="bi bi-info-circle me-1"></i>
                Tip: You can search for skills (e.g., "C#", "Azure") found inside candidate resumes.
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading candidates...</p>
        </div>
    }
    else if (candidates == null || !candidates.Any())
    {
        <div class="text-center py-5 bg-light rounded-3 border border-dashed">
            <i class="bi bi-people text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-muted">No candidates found</h4>
            @if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                <p class="text-muted">Try adjusting your search query or <a href="javascript:void(0)" @onclick="ClearSearch">clear filters</a>.</p>
            }
            else
            {
                <p class="text-muted">Get started by adding a new candidate.</p>
                <button class="btn btn-primary mt-2" @onclick="NavigateToAdd">
                    Add Candidate
                </button>
            }
        </div>
    }
    else
    {
        <div class="table-responsive shadow-sm rounded bg-white">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Full Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Resume</th>
                        <th class="text-end pe-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var candidate in candidates)
                    {
                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-initials bg-light text-primary rounded-circle me-3 d-flex align-items-center justify-content-center fw-bold" style="width: 40px; height: 40px;">
                                        @GetInitials(candidate.Fullname)
                                    </div>
                                    <div>
                                        <div class="fw-bold">@candidate.Fullname</div>
                                        <small class="text-muted">Added @candidate.CreatedAt.ToShortDateString()</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <a href="mailto:@candidate.Email" class="text-decoration-none text-body">
                                    @candidate.Email
                                </a>
                            </td>
                            <td>@candidate.Phone</td>
                            <td>
                                @if (resumeUrls.TryGetValue(candidate.Id, out var resumeUrl) && !string.IsNullOrEmpty(resumeUrl))
                                {
                                    <div class="btn-group btn-group-sm">
                                        <a href="@resumeUrl" target="_blank" class="btn btn-outline-secondary" title="View Resume">
                                            <i class="bi bi-file-earmark-pdf"></i> View
                                        </a>
                                        <a href="@resumeUrl" download class="btn btn-outline-secondary" title="Download Resume">
                                            <i class="bi bi-download"></i>
                                        </a>
                                    </div>
                                }
                                else
                                {
                                    <span class="badge bg-light text-muted border">No Resume</span>
                                }
                            </td>
                            <td class="text-end pe-4">
                                <div class="btn-group">
                                    <button class="btn btn-outline-primary btn-sm" @onclick="() => NavigateToDetail(candidate.Id)" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" @onclick="() => NavigateToEdit(candidate.Id)" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" @onclick="() => HandleDeleteCandidate(candidate.Id)" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted small">
                Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, totalCount) of @totalCount candidates
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="PreviousPage" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </button>
                    </li>
                    
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        var pageNumber = i; // Capture variable
                        <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                            <button class="page-link" @onclick="() => GoToPage(pageNumber)">@pageNumber</button>
                        </li>
                    }

                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="NextPage" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger mt-3 alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> @errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = null" aria-label="Close"></button>
            </div>
        }
    }
</div>

@code {
    private List<HRSystem.UI.DTOs.CandidateDto> candidates;
    private string errorMessage;
    private string searchQuery = string.Empty;
    private Dictionary<Guid, string> resumeUrls = new();
    private bool isLoading = true;

    // Pagination state
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalCount = 0;
    private int totalPages => (int)Math.Ceiling((double)totalCount / pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadCandidates();
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchCandidates();
        }
    }

    private async Task LoadCandidates()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            HRSystem.UI.DTOs.PagedResult<HRSystem.UI.DTOs.CandidateDto> result;

            if (string.IsNullOrWhiteSpace(searchQuery))
            {
                result = await CandidateService.GetAllAsync(currentPage, pageSize);
            }
            else
            {
                result = await CandidateService.SearchAsync(searchQuery, currentPage, pageSize);
            }

            candidates = result.Items;
            totalCount = result.TotalCount;
            
            // Reset resume URLs
            resumeUrls.Clear();
            foreach (var candidate in candidates)
            {
                if (!string.IsNullOrEmpty(candidate.ResumePath))
                {
                    var url = await CandidateService.GetResumeUrlAsync(candidate.Id);
                    resumeUrls[candidate.Id] = url;
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred while loading candidates. Please try again.";
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SearchCandidates()
    {
        currentPage = 1; // Reset to first page on new search
        await LoadCandidates();
    }

    private async Task ClearSearch()
    {
        searchQuery = string.Empty;
        currentPage = 1;
        await LoadCandidates();
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadCandidates();
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadCandidates();
        }
    }

    private async Task GoToPage(int page)
    {
        if (page != currentPage)
        {
            currentPage = page;
            await LoadCandidates();
        }
    }

    private void NavigateToAdd()
    {
        Navigation.NavigateTo("/candidates/add");
    }

    private void NavigateToEdit(Guid id)
    {
        Navigation.NavigateTo($"/candidates/edit/{id}");
    }

    private void NavigateToDetail(Guid id)
    {
        Navigation.NavigateTo($"/candidates/{id}");
    }

    private async Task HandleDeleteCandidate(Guid id)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this candidate?"))
        {
            return;
        }

        var success = await CandidateService.DeleteAsync(id);
        if (success)
        {
            await LoadCandidates();
        }
        else
        {
            errorMessage = "Failed to delete candidate.";
        }
    }

    private string GetInitials(string fullname)
    {
        if (string.IsNullOrWhiteSpace(fullname)) return "?";
        var parts = fullname.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1) return parts[0][0].ToString().ToUpper();
        return $"{parts[0][0]}{parts[parts.Length - 1][0]}".ToUpper();
    }
}